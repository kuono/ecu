# Change log for ECU Monitor for Rover MEMS 1.3 and 1.6 by K.Uono

## Unreleased changes

ライブラリとはいえ，ほとんど本体プログラムと化している。APIという考え方ができる前に学んだプログラミングなので時代に追いついていない。もう少し勉強しないとね。

## 動作の前提条件

   1) ECUと接続するシリアルケーブルがあること。なければ作ること。
   2) シリアル-USB変換ケーブルがあること。なければ作ること。
   3) 変換ケーブルのドライバをインストールすること。
 ちなみに魚野は FTDI Chips の変換基盤を使用したUSBシリアル変換ケーブルを自作したので，[FTDI Chips 社 製の VCP ドライバ](https://www.ftdichip.com/Drivers/VCP.htm) をインストールした。なお，最近のmacOSでは，インストールの途中，機能拡張がブロックされるので，セキュリティとプライバシーで実行を許可することが必要。

## Change history

### 0.13.0 2022.01.30

- ラズパイの小さなスクリーン用に，再度いくつかの表示要素の配置を見直した。
- バージョン番号についてTemplateHaskellを使って自動でcabalファイルから持ってくるようにした。

### 0.12.4 2022.01.22

- ラズパイのシステム稼働後の挙動を，終了時に押すキー一つで選べるようにした（q:Quit s:Shutdown R:Restart)。
- ラズパイの小さなモニタではUnknownの表示だけしか見えていなかったので，エラー表示が見えるように表示要素の配置を変更した。

### 0.12.3 2021.11.01

- 初期化プロトコルで失敗した際にポートを閉じていなかった
- init関数の戻り値の型を Maybe Env から Either String Env に変更

### 0.12.2 2021.09.11

- port non-close bug was fixed for raspberry pi
- auto shutdown call for raspberian is temporary stopped.

### 0.12.1 2021.08.29

- type of MEMS monad was changed. MEMSモナドの型を変更した（ExceptTを組み込む）

### 0.12.0 2021.07.30

- DHall 導入。config ファイルの導入

### 0.11.2 2021.07.28

- AppStatus にOSの違いを表す欄を追加。RaspberryPi OS と小さなモニタセットでの行数の少なさに対応

### 0.11.1 2021.07.26

- RaspberryPi OS への対応
  - ecu.cabalの修正 ... 1) RTSオプション 全部削除, 2) 
  - README.mdの修正 ... 日本語フォントが必須であることの追記

### 0.11.0 2021.07.20

- ひょっとして TestBits でうまくエラーコードを検出できていない？→ 多分治った v.0.11.0
- エラーコード表示周りのバグ修正　：　testBit の使い方が間違っていた。

## 0.3.0.0 2019.03.10

- TestModeを追加
- ./log/ECU...としていたが，ディレクトリが存在していないとランタイムエラーを起こすので変更

-- #   2019.03.15 v.0.3.0.0  TestMode追加 - メインループやスレッド構成を見直し→読み出しエラー頻発
-- #   2019.03.15 v.0.3.0.1  読み出しエラー対策のため割り込み対処構成見直し；依然エラー頻発。
-- #   2019.03.17 v.0.3.0.2  正格評価化，割り込み対策，メインループをEitherモナド化

## 0.4.0.0 2019.04.02

- Elmに触発された枠組みに変更
- 抽象化をより進める

## 0.4.0.1

2019.04.14 v.0.4.0.1

- 起動時，ECUがつながっていないと例外が見えてしまっていることの対処
- 画面表示に単位を表示
- 冒頭表示サイズ通りでないバイト数しかとれなかった場合のランタイムエラー回避

## 0.4.0.2

2019.04.29 v.0.4.0.2

- HDMIモニターでの表示用に，若干行数を縮めた。
- 閉じたシリアルポートを再度閉じようとして起こしている例外の捕捉コードを追加

## 0.4.0.4

2019.05.06 v.0.4.0.4

- エラーが出た後，標準表示の際にエラー表示が残る部分（engine speed)の表示後続部分リセット追加
- RaspberryPi での動作確認開始
- RaspberryPi のデバイスパスが macOS と異なることの対応

ecu-exe: Data.ByteString.index: index too large: 10, length = 9
CallStack (from HasCallStack):**
  error, called at libraries/bytestring/Data/ByteString.hs:1877:23 in bytestring-0.10.8.2:Data.ByteString
ecu-exe: Data.ByteString.index: index too large: 10, length = 9
CallStack (from HasCallStack):*
  error, called at libraries/bytestring/Data/ByteString.hs:1877:23 in bytestring-0.10.8.2:Data.ByteString
     map Sensor(kPa):     33  **

## 0.4.0.5

2019.06.16 v.0.4.0.5

- オートマ向けECUに切り替えたので機種として追加（ただし，データ数等は未知）
- 累積グラフをつけた

## 0.4.0.6

2019.06.27 v.0.4.0.6

- 未知形式のECU用に，Connected表示の後に80,7dのデータ数を表記

## 0.4.1.0

2019.07.01 v.0.4.1.0

- Data80,Data7dを統合

## 0.4.1.1

2019.07.02 v.0.4.1.1

- 過去データをチャネル経由で共有するのではなく displayer 内のみに閉じ込めるようにした。
- 未知のECUをつないだときの対応
-- 知らないECUデータであればネゴをしてデータ数を調べる）
-- 未知型式のECUが接続されたら試しに7D,80を発行し，データサイズを見る。
-- -> 常時データ受信数（１バイト目）を表示するように

## 0.4.1.2

2019.07.03 v.0.4.1.2

- ECUが反応しなくても，接続に挑戦し続けるようにできた。
- 最初に走らせ始めた時に無反応だと，自動では接続しない問題を解決。
- 途中でECUが無反応になった時，何もしないと再接続しない。
- 小さな画面対策のため，Log の表示は１行のみにする。

## 0.4.2.0

2019.07.05 v.0.4.2.0

- 中止：vi 形式のモード切替（コマンドモード，モニタモード）

## 0.5.0

2019.07.20 v.0.5.0

- グラフを描き始めた
- 前々日，室内で冷却液漏れ発生し，実車で試せていない。大丈夫か？

## 0.6.0

2019.07.31 v.0.6.0

- UI モジュールの分割

## 0.8

TUI化

2019.09.16 v0.8.2

- 読み出し正常化

2019.09.16 v.0.8.3

- IACPos関係追加
- モデル名と初回80,7d受信データ長を表示することに
- なぜかindexエラーが出ていたが，読み出し時，毎回長さを点検し，異常時はねることに
- ラムダセンサー値グラフ表示の上限値を1000mVに。
- 進角等の設定関数を作成した。でもMEMS1.3は対応していない？

2019.09.21 v.0.8.4

- textPlot導入。グラフを単なる棒グラフの寄せ集めから重ね合わせグラフに(複数の項目を一つのグラフに表示)
- --ghc-options -XBangPatterns を導入（ECU.hsでアキュムレータを使った計算があるため，空間リークの防止）

2019.10.13 v.0.8.5

- BSをBS.Char８に（ラズパイ上でコンパイルすると内部モジュールで使用する名前と重複してエラーとなることの回避）
- グラフのカラー化

2019.11.17 v.0.8.6

- ログにエラーフラグを追記

2019.12.30 v.0.8.7

- bitTest 用の　Word8 -> Int を ord から fromEnum に変更

2020.01.11 v.0.8.8

- Model への追加情報：IAC POS, 進度（常時表示用），出発時冷却温度（冷却温度表示の着色＝出発準備完了表示）

2020.01.24 v.0.8.9

- 読み出し頻度が早すぎるかのチェックで頻度を0.5秒ごとから1.0秒ごとにしてみたが，瞬停はおさまらなかった。

2020.01.25 v.0.9.0

- フォールトコードをログおよび画面に表示。画面では各ビットの，ログ・ファイルにはコードデータの表示に。
- 命令がうまくいった場合，どんな命令を発行したかをログに記録するようにした。
- 読み出し頻度を0.4秒ごとに戻した。
- フォールトは，0dが0x20,0eが0x20だったが，リセットをかけたところ，0x20,0x00となった。
  0x0dの0x20は，燃料温度センサーエラーだが，これはMiniでは使われていないフラグのはず。
- あいかわらず，初回に接続してしばらくすると接続が切れて復帰できなくなる問題は継続。

2020.04.10 v.0.9.1

- 初回に接続してしばらくすると接続が切れて復帰できなくなる問題について試行錯誤中

2020.09.20 v.0.9.2

- Raspberry Pi での稼働（コンパイル環境，運用環境）確認だと思うが，記憶があいまい。

2020.12.30 v.0.10.0

Graph Widget 装備

-- #   2018.10.14 デバイスが存在しない場合にその旨表示する。unknown データをすべて表示する。
--                異常・正常結果を常に表示。ログファイル書き込みと画面表示の両方を用意。
-- #   2018.11.11 v.0.2.0.1 マルチスレッド化->logが書き込まれない。Chanにデータが入っていかない？
-- #   2018.11.12 v.0.2.0.2 例外処理が使いこなせずコンパイルが通らないのでEither Error DataQQに。
-- #   2018.11.16 v.0.2.0.3 tryなどを使ってみる
-- #   2018.11.16 v.0.2.0.4 MVarなど導入。並列化。
-- #    なぜかputStrだと画面が更新されない->putStrLnに
-- #    単純にCommunicatorとLoggerをforkするとloggerが先に始まってしまうことの対策
-- #      -> Chan (MVar ECUStatus)で解決
-- #    E80, E7D 時のスレッド再起動処理を埋め込む
-- #    hscurses化 -> ウィンドウの大きさを超えて画面出力すると例外が起こるので，一旦利用中止。
-- #   2018.11.16 v.0.2.0.5 キー入力でrunwithecuに非同期例外を投げるとエンジンが瞬停する。
-- #    手抜きのモデルデータ表示をやめる
-- #   2018.12.13 v.0.2.0.6 累積データを表示させるようにするため，新たにデータ型を追加し，関数引数の変更等を行う。
-- #    突然電源ECUから反応がなくなった場合のエラー処理
-- #    ND , NC エラーときの自動待機・接続挑戦継続
-- #    error code reset command
-- #    これらのエラー処理を，Monadを使ってログに書き込んでいく
-- #    画面表示でログを表示する
-- #    エラーを表示した後，復帰しない（catch処理を組み込み）
-- #   2018.12.25 v.0.2.0.7  不要な試行錯誤コード整理
-- #                         default log directory setting in command line arg
-- #   2019.01.02 v.0.2.0.8  最小・最大データを記録・表示するように
-- #   2019.01.27 v.0.2.0.9  通し番号も表示するように
-- #   2019.01.29 v.0.2.0.10 接続がおかしくなった。原因は？？？←１本カプラが外れていた。→ケーブルコネクタを固定できるカップラーに変更
-- #                         エンジン速度を基準に，エラーを画面ログ部分に蓄積表示していたが，上限値超えのみ表示に。将来的には機械学習におきかえる？
-- #                         一度エラーが出ると接続がおかしくなる。例外のマスキングを正しく行うこと。
-- #                         初期化が成功したら一旦画面をクリアする。
-- #                         状態遷移をきちんと制御する。-> 例外をやめ，メッセージ化した
-- #                         動作中にケーブルを引っこ抜くと，Index例外が発生。デバイスも見つけられなくなる。
-- #                             →標準長に満たないデータ来たときはエラー処理する
-- #                         未接続状態でqを押してもQuitできない？
-- #                         throttle pot metorの値がおかしい（0.28〜3.33）→100倍していたのを10倍に
-- #                         E80,E7D 直後に初期化できない。読み込みバッファにデータ残っていそう。
-- #
-- #                         Post process for average caliculation and defect detection
-- #                         ライブラリ化・絞り込み（Chan ECUDataを輸出）
-- #                         threepenny.gui を使ったデータ履歴表示
-- #                         データソースの属性を記述する方式に変更（Stream/Cell, Retry/STOP, ....)
-- #                         ん？それってFRP？でも失敗時の振る舞いを加味する操作は入っていないかも
-- #                         q で抜ける時，logger にフラッシュさせる
-- #   2019.02.19 v.0.2.1.0  一旦，安定版とする。
-- #   2019.03.09 v.0.2.1.1  テストデータモード追加。以降，GitHubにプロジェクト登録
-- #
-- # GUI 準備 (Threepenny-guiの導入)　とりあえず動いたが，終了方法未詳。
-- #
-- # いきなりプラグを抜くと ecu-exe: discardData: does not exist (Device not configured)
-- #   これはどうやら Linux, macOSの場合である。 discardData関数がシステムコールでエラーを
-- #   受け取っている。
-- #   [discardData についての説明](http://hackage.haskell.org/package/unix-2.7.2.2/docs/src/System.Posix.Terminal.Common.html#discardData)
-- # -- | @discardData fd queues@ calls @tcflush@ to discard
-- # --   pending input and\/or output for @Fd@ @fd@,
-- # --   as indicated by the @QueueSelector@ @queues@.
